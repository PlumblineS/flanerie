<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fl√¢nerie - The Art of Urban Wandering</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;600;700;800&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Poppins', sans-serif; overflow-x: hidden; background: #0a0a0a; color: #8DBCC0; --accent-color: #6B9B9E; --accent-light: #8DBCC0; }
        body.choreography-active { overflow: hidden; height: 100vh; position: fixed; width: 100%; }
        
        /* Navigation */
        nav { position: fixed; top: 0; width: 100%; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(10px); padding: 1.5rem 2rem; z-index: 1000; border-bottom: 1px solid rgba(107, 155, 158, 0.2); }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .nav-links { display: flex; gap: 3rem; list-style: none; }
        .nav-links a { text-decoration: none; color: var(--accent-light); font-weight: 500; font-size: 1.1rem; transition: color 0.3s ease; }
        .nav-links a:hover { color: #ffffff; }
        .nav-auth { display: flex; align-items: center; }
        .auth-btn { background: linear-gradient(135deg, var(--accent-color), #8dbcc0); color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(107, 155, 158, 0.4); }
        
        /* Hero Section */
        .hero { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: relative; padding: 6rem 2rem 4rem; background: url('character-bg.png') center/cover fixed; }
        .hero::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 10, 0.6); backdrop-filter: blur(6px); z-index: 1; }
        .hero-content { position: relative; z-index: 2; max-width: 900px; }
        .hero h1 { font-family: 'Playfair Display', serif; font-size: 7rem; font-weight: 400; color: var(--accent-light); margin-bottom: 1rem; letter-spacing: 3px; text-shadow: 0 5px 30px rgba(0, 0, 0, 0.8); }
        .hero-subtitle { font-size: 1.8rem; color: var(--accent-light); font-weight: 300; margin-bottom: 2rem; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8); }
        .hero-logo-btn { width: 200px; height: 200px; margin: 0 auto 2rem; border-radius: 50%; background: url('character-logo.png') center/cover; border: 5px solid var(--accent-color); cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 40px rgba(107, 155, 158, 0.4); animation: float 3s ease-in-out infinite; }
        .hero-logo-btn:hover { transform: scale(1.05); box-shadow: 0 15px 60px rgba(107, 155, 158, 0.6); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* Rotating Text */
        .rotating-text-container { min-height: 50px; position: relative; margin-bottom: 1rem; }
        .rotating-text { position: relative; width: 100%; text-align: center; }
        .rotating-text span { position: absolute; width: 100%; left: 0; opacity: 0; color: var(--accent-light); font-size: 1.2rem; font-weight: 300; font-style: italic; transition: opacity 1s ease-in-out; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8); }
        .rotating-text span.active { opacity: 1; }
        
        /* Main Content */
        .main-content { position: relative; background: #0a0a0a; padding: 6.5rem 0 2rem; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; }
        
        /* Info & Feature Sections */
        .info-section { text-align: center; padding: 1.5rem 0 0.5rem; max-width: 900px; margin: 0 auto 1.5rem; }
        .definition-box-animated { margin-bottom: 1.2rem; text-align: left; max-width: 700px; margin-left: auto; margin-right: auto; background: rgba(30, 30, 30, 0.8); padding: 1.3rem; border-radius: 15px; border-left: 4px solid var(--accent-color); }
        .definition-box-animated h2 { font-family: 'Playfair Display', serif; font-size: 2.6rem; font-weight: 400; color: var(--accent-light); margin-bottom: 0.4rem; }
        #welcome-section { text-align: left; max-width: 1200px; margin: 0 auto 2rem; background: rgba(30, 30, 30, 0.5); padding: 2rem 3rem; border-radius: 20px; }
        #welcome-section h3 { font-family: 'Playfair Display', serif; color: var(--accent-color); font-size: 2.5rem; margin-bottom: 1.2rem; }
        #tagline-reveal { margin-top: 1rem; font-family: 'Playfair Display', serif; font-size: 1.8rem; color: var(--accent-color); font-style: italic; font-weight: 700; text-align: center; }
        
        /* Feature Cards */
        .features-section { min-height: auto; padding: 2.5rem 2rem 2rem; scroll-margin-top: 80px; display: flex; align-items: flex-start; justify-content: center; }
        .feature-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; max-width: 1400px; width: 100%; margin: 0 auto; }
        .feature-card-large { background: rgba(30, 30, 30, 0.9); border-radius: 20px; padding: 1.5rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; cursor: pointer; border: 2px solid rgba(107, 155, 158, 0.2); display: flex; align-items: center; justify-content: center; min-height: 280px; max-height: 360px; }
        .feature-card-large:hover { transform: translateY(-5px); box-shadow: 0 20px 60px rgba(107, 155, 158, 0.3); border-color: var(--accent-color); }
        .feature-content { position: relative; z-index: 3; text-align: center; width: 100%; }
        .feature-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-color), var(--accent-light)); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 1rem; }
        .feature-card-large h3 { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--accent-light); margin-bottom: 0.75rem; }
        .feature-btn { background: linear-gradient(135deg, var(--accent-color), var(--accent-light)); color: white; padding: 0.75rem 1.85rem; border: none; border-radius: 50px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .feature-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(107, 155, 158, 0.5); }
        .feature-btn:disabled { background: rgba(80, 80, 80, 0.5); color: rgba(255, 255, 255, 0.4); cursor: not-allowed; }

        /* Footer */
        footer { background: rgba(10, 10, 10, 0.98); color: var(--accent-light); padding: 2rem 2rem 1rem; border-top: 2px solid rgba(107, 155, 158, 0.3); }
        .footer-content { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; margin-bottom: 1rem; }
        .footer-section h4 { color: var(--accent-color); margin-bottom: 1rem; }
        .footer-section a { color: var(--accent-light); text-decoration: none; line-height: 2; transition: color 0.3s; }
        .footer-section a:hover { color: #ffffff; }
        .footer-section ul { list-style: none; }
        .footer-bottom { text-align: center; padding-top: 2rem; border-top: 1px solid rgba(107, 155, 158, 0.2); color: #999; }

        /* Slideshow */
        .slideshow-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #0a0a0a; z-index: 10000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; overflow: hidden; }
        .slideshow-overlay.active { opacity: 1; pointer-events: all; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transition: opacity 1s ease-in-out; padding: 4rem 2rem; }
        .slide.active { opacity: 1; }
        .slide-content { text-align: center; max-width: 800px; width: 100%; }
        
        #slide-typewriter-with-image { justify-content: flex-start; padding-top: 10%; }
        #slide-typewriter-with-image .typewriter-section { margin-bottom: 2.5rem; min-height: 120px; display: flex; flex-direction: column; align-items: center; }
        #slide-typewriter-with-image .image-section { opacity: 0; transition: opacity 4s ease-in; display: flex; justify-content: center; width: 100%; }
        #slide-typewriter-with-image .image-section.fading { opacity: 1; }
        
        #slide-paragraph-with-image { justify-content: flex-start; padding-top: 8%; }
        #slide-paragraph-with-image .paragraph-section { margin-bottom: 3rem; display: flex; justify-content: center; width: 100%; }
        #slide-paragraph-with-image .image-section { opacity: 0; transition: opacity 3s ease-in; margin-top: 2rem; display: flex; justify-content: center; width: 100%; }
        #slide-paragraph-with-image .image-section.fading { opacity: 1; }
        #slide-paragraph-with-image .you-text { opacity: 0; transition: opacity 1.5s ease-in; font-family: 'Playfair Display', serif; color: var(--accent-color); font-size: 4rem; font-weight: 700; margin-bottom: 1rem; }
        #slide-paragraph-with-image .you-text.showing { opacity: 1; }
        
        #slide-welcome #welcome-text { font-family: 'Playfair Display', serif; color: var(--accent-color); font-size: 3rem; font-weight: 600; transition: transform 2s ease-out; }
        #slide-welcome #welcome-text.move-up { transform: translateY(-40px); }
        #slide-welcome #tagline-text { font-family: 'Playfair Display', serif; font-size: 2.5rem; color: var(--accent-color); font-style: italic; font-weight: 700; opacity: 0; margin-top: 2rem; transition: opacity 1s ease-in; }
        #slide-welcome #tagline-text.fade-in { opacity: 1; }
        #slideshow-typewriter-sentence { font-family: 'Crimson Text', serif; font-size: 1.6rem; color: var(--accent-light); font-weight: 600; text-align: center; min-height: 50px; }
        
        .slideshow-controls { position: fixed; bottom: 2rem; right: 2rem; z-index: 10001; display: flex; gap: 1rem; }
        .slideshow-controls button { background: rgba(107, 155, 158, 0.3); border: 2px solid var(--accent-color); color: var(--accent-color); width: 50px; height: 50px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: all 0.3s ease; }
        .slideshow-controls button:hover { background: var(--accent-color); color: #0a0a0a; }

        /* Media Queries */
        @media (max-width: 1024px) { .feature-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 968px) { .feature-grid { grid-template-columns: 1fr; gap: 2rem; } }
        @media (max-width: 768px) { 
            .hero h1 { font-size: 3.5rem; }
            .hero-subtitle { font-size: 1.2rem; }
            .hero-logo-btn { width: 150px; height: 150px; }
            .nav-links { gap: 1rem; font-size: 0.9rem; }
            .container { padding: 0 1rem; }
            #welcome-section { padding: 2rem; }
            .definition-box-animated h2 { font-size: 2.5rem; }
            .footer-content { grid-template-columns: 1fr 1fr; }
        }

        /* Modal Styles */
        .modal { position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: linear-gradient(135deg, rgba(20, 20, 20, 0.98), rgba(30, 30, 30, 0.98)); padding: 2rem; border-radius: 20px; border: 2px solid rgba(107, 155, 158, 0.3); box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s ease; }
        .close:hover { color: var(--accent-light); }
    </style>
</head>
<body>
    <div id="slideshow-overlay" class="slideshow-overlay">
        <div class="slideshow-controls">
            <button id="rewind-btn" title="Restart">‚Ü∫</button>
            <button id="pause-btn" title="Pause/Play">‚è∏</button>
            <button id="skip-btn" title="Skip">‚è≠</button>
        </div>
        <div class="slide active" id="slide-definition">
            <div class="slide-content">
                <h2 style="font-family: 'Playfair Display', serif; font-size: 4rem; color: var(--accent-light); margin-bottom: 1rem;">fl√¢nerie</h2>
                <p style="font-size: 1.2rem; color: var(--accent-light); margin-bottom: 2rem; font-style: italic;">| Ààfl…ëÀên…ôri |</p>
                <p style="font-size: 1.6rem; color: var(--accent-light); line-height: 1.8;">The art of leisurely urban exploration;<br>mindful wandering through city streets<br>with intention and curiosity.</p>
            </div>
        </div>
        <div class="slide" id="slide-typewriter-with-image">
            <div class="typewriter-section">
                <h3 style="font-family: 'Playfair Display', serif; color: var(--accent-color); font-size: 2.8rem; margin-bottom: 2.5rem; text-align: center;">Take Back Your Main Street</h3>
                <p id="slideshow-typewriter-sentence"></p>
            </div>
            <div class="image-section" id="empty-street-section">
                <img src="empty-street.png" alt="Empty street" style="max-width: 500px; width: 80%; height: auto; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            </div>
        </div>
        <div class="slide" id="slide-paragraph-with-image">
            <div class="paragraph-section">
                <p style="font-size: 1.3rem; color: var(--accent-light); line-height: 1.9; text-align: center; max-width: 800px;">
                    Search engines direct you to chains. Online shopping replaces neighborhood stores. Meanwhile, the caf√© owner who remembers your name can't make rent. Small businesses don't have marketing budgets or algorithms working for them ‚Äî they have...
                </p>
            </div>
            <div class="you-text" id="you-text">YOU</div>
            <div class="image-section" id="shopping-street-section">
                <img src="shopping-street.png" alt="Shopping street" style="max-width: 500px; width: 80%; height: auto; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            </div>
        </div>
        <div class="slide" id="slide-welcome">
            <div class="slide-content">
                <h3 id="welcome-text">Welcome to Fl√¢nerie</h3>
                <p id="tagline-text">Share your journey.<br>Retrace theirs.</p>
            </div>
        </div>
    </div>
    
    <nav>
        <div class="nav-container">
            <ul class="nav-links">
                <li><a href="#home">Home</a></li>
                <li><a href="javascript:void(0)" onclick="scrollToContent()">How It Works</a></li>
                <li><a href="javascript:void(0)" onclick="scrollToExplore()">Explore</a></li>
                <li><a href="for-businesses.html">For Businesses</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <div class="nav-auth">
                <button id="sign-in-btn" class="auth-btn" onclick="showSignInModal()">Sign In</button>
                <div id="user-info" style="display: none;">
                    <span id="user-name" style="color: var(--accent-light); margin-right: 1rem;">Hi, User!</span>
                    <button class="auth-btn" onclick="openDashboard()" style="margin-right: 0.5rem;">Dashboard</button>
                    <button id="sign-out-btn" class="auth-btn" onclick="signOut()">Sign Out</button>
                </div>
            </div>
        </div>
    </nav>
    
    <div id="verification-banner" style="display: none; position: fixed; top: 80px; left: 0; right: 0; background: linear-gradient(135deg, rgba(255, 152, 0, 0.95), rgba(255, 193, 7, 0.95)); padding: 1rem 2rem; text-align: center; z-index: 999; border-bottom: 2px solid rgba(255, 152, 0, 0.5);">
        <p style="margin: 0; color: #000; font-weight: 600; font-size: 1rem;">
            ‚úÖ You're signed in! üìß Check your email and click the verification link to start posting. 
            <span style="color: #000; font-size: 0.85rem; opacity: 0.8;">(Auto-checking...)</span>
            <a href="javascript:void(0)" onclick="resendVerificationEmail()" style="color: #000; text-decoration: underline; font-weight: 700; cursor: pointer; margin-left: 1rem;">Resend email</a>
        </p>
    </div>
    
    <section class="hero" id="home">
        <div class="hero-content">
            <h1>Fl√¢nerie</h1>
            <p class="hero-subtitle">The art of urban wandering.</p>
            <div class="hero-logo-btn" onclick="scrollToContent()"></div>
            <div class="rotating-text-container">
                <div class="rotating-text">
                    <span class="active">Wander well.</span>
                    <span>Walk kindly.</span>
                    <span>Support local business.</span>
                    <span>Discover hidden gems in your neighborhood.</span>
                    <span>Turn ordinary walks into extraordinary adventures.</span>
                    <span>Connect with your community, one step at a time.</span>
                    <span>Every block has a story to tell.</span>
                    <span>Shop small, feel big.</span>
                    <span>Find your city's secrets.</span>
                    <span>Life moves fast - walk slower.</span>
                </div>
            </div>
        </div>
    </section>
    
    <main class="main-content">
        <div class="container">
            <section class="info-section">
                <div class="definition-box-animated">
                    <h2>fl√¢nerie</h2>
                    <p style="font-size: 1rem; color: var(--accent-light); margin-bottom: 0.3rem;">| Ààfl…ëÀên…ôri | <span style="font-style: italic;">noun</span></p>
                    <div style="width: 60px; height: 1px; background: #555; margin: 1rem 0;"></div>
                    <p style="font-size: 1.3rem; color: var(--accent-light); line-height: 1.7;">The art of leisurely urban exploration; mindful wandering through city streets with intention and curiosity.</p>
                </div>
                <div id="welcome-section">
                    <h3>Welcome to Fl√¢nerie</h3>
                    <p>We turn ordinary walks into extraordinary mini-adventures. Rooted in French culture, fl√¢nerie celebrates <strong style="color: var(--accent-color);">the art of strolling</strong> ‚Äî observing city life with intention instead of rushing through it. It's <strong style="color: var(--accent-color);">cultural appreciation</strong> in motion: slowing down enough to notice the character and charm built into the everyday.</p>
                    <p>With Fl√¢nerie, you can explore neighborhoods at your own pace or chart your own path. Our routes guide you from cozy caf√©s and local markets to boutique shops, art galleries, bookstores, parks, and hidden corners ‚Äî each designed for <strong style="color: var(--accent-color);">mindful wandering</strong> and curiosity-led discovery. Search routes shared by others, map your upcoming outings, browse local events, or gather friends for a <strong style="color: var(--accent-color);">Shopping Swarm</strong> ‚Äî a collective walk that turns routine errands into moments of connection and community support.</p>
                    <p><strong style="color: var(--accent-color);">Your route to that tiny coffee roaster? Someone else's new favorite spot. Your Shopping Swarm? A local merchant's best weekend in months.</strong> This is how communities strengthen themselves ‚Äî one walk, one recommendation, one conscious choice at a time.</p>
                </div>
                <p id="tagline-reveal">Share your journey. Retrace theirs.</p>
            </section>
            
            <div id="features-content" class="features-section">
                <div class="feature-grid">
                    <div class="feature-card-large">
                        <div class="feature-content">
                            <div class="feature-icon">üìç</div>
                            <h3>Journeys & Routes</h3>
                            <p>Share your path or discover new ones</p>
                            <button class="feature-btn" onclick="toggleSection('journey-map')" style="margin-bottom: 0.75rem;">Share Your Journey</button>
                            <button class="feature-btn" onclick="toggleSection('search')">Search Routes</button>
                        </div>
                    </div>
                    <div class="feature-card-large">
                        <div class="feature-content">
                            <div class="feature-icon">üõçÔ∏è</div>
                            <h3>Shopping Swarms</h3>
                            <p>Create or join community walks</p>
                            <button class="feature-btn" onclick="toggleSection('swarm-map-v2')" style="margin-bottom: 0.75rem;">Create Shopping Swarm</button>
                            <button class="feature-btn" onclick="toggleSection('swarms')">View Swarms</button>
                        </div>
                    </div>
                    <div class="feature-card-large">
                        <div class="feature-content">
                            <div class="feature-icon">üéâ</div>
                            <h3>Local Events</h3>
                            <p>Promote events or discover celebrations</p>
                            <button class="feature-btn" onclick="toggleSection('event-map-v2')" style="margin-bottom: 0.75rem;">Promote Your Event</button>
                            <button class="feature-btn" onclick="toggleSection('events')">Browse Events</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>Fl√¢nerie</h4>
                <p>The art of urban wandering.</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="#contact">Contact</a></li>
                    <li><a href="for-businesses.html">For Businesses</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Community</h4>
                <ul>
                    <li><a href="#blog">Blog</a></li>
                    <li><a href="#stories">Stories</a></li>
                    <li><a href="#events">Events</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Connect</h4>
                <ul>
                    <li><a href="#instagram">Instagram</a></li>
                    <li><a href="#twitter">Twitter</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Fl√¢nerie. All rights reserved. Made with ‚ù§Ô∏è for urban explorers.</p>
        </div>
    </footer>
    
    <script>
        // SLIDESHOW - APPROVED TIMING
        const typewriterText = "Every year, 200,000 small businesses close in the U.S. alone.";
        let charIndex = 0;
        
        function startSlideshow() {
            const slideshowOverlay = document.getElementById('slideshow-overlay');
            document.body.classList.add('choreography-active');
            slideshowOverlay.classList.add('active');
            
            setTimeout(() => {
                document.getElementById('slide-definition').classList.remove('active');
                document.getElementById('slide-typewriter-with-image').classList.add('active');
                setTimeout(() => { document.getElementById('empty-street-section').classList.add('fading'); }, 100);
                slideshowTypewriter(() => {
                    setTimeout(() => {
                        document.getElementById('slide-typewriter-with-image').classList.remove('active');
                        document.getElementById('slide-paragraph-with-image').classList.add('active');
                        setTimeout(() => {
                            document.getElementById('you-text').classList.add('showing');
                            setTimeout(() => {
                                document.getElementById('shopping-street-section').classList.add('fading');
                                setTimeout(() => {
                                    setTimeout(() => {
                                        document.getElementById('slide-paragraph-with-image').classList.remove('active');
                                        document.getElementById('slide-welcome').classList.add('active');
                                        setTimeout(() => {
                                            document.getElementById('welcome-text').classList.add('move-up');
                                            document.getElementById('tagline-text').classList.add('fade-in');
                                            setTimeout(() => {
                                                slideshowOverlay.style.transition = 'opacity 1s ease-out';
                                                slideshowOverlay.style.opacity = '0';
                                                setTimeout(() => {
                                                    slideshowOverlay.style.display = 'none';
                                                    document.body.classList.remove('choreography-active');
                                                }, 1000);
                                            }, 4000);
                                        }, 2000);
                                    }, 3000);
                                }, 3000);
                            }, 1500);
                        }, 4000);
                    }, 5000);
                });
            }, 4000);
        }
        
        function slideshowTypewriter(callback) {
            const element = document.getElementById('slideshow-typewriter-sentence');
            element.textContent = '';
            charIndex = 0;
            function type() {
                if (charIndex < typewriterText.length) {
                    element.textContent += typewriterText.charAt(charIndex);
                    charIndex++;
                    setTimeout(type, 50);
                } else { callback(); }
            }
            type();
        }
        
        document.getElementById('skip-btn').addEventListener('click', function() {
            const slideshowOverlay = document.getElementById('slideshow-overlay');
            slideshowOverlay.style.transition = 'opacity 0.5s ease-out';
            slideshowOverlay.style.opacity = '0';
            setTimeout(() => {
                slideshowOverlay.style.display = 'none';
                document.body.classList.remove('choreography-active');
            }, 500);
            sessionStorage.setItem('flanerie-slideshow-seen', 'true');
        });
        
        document.getElementById('pause-btn').addEventListener('click', function() { this.textContent = this.textContent === '‚è∏' ? '‚ñ∂' : '‚è∏'; });
        document.getElementById('rewind-btn').addEventListener('click', function() {
            charIndex = 0;
            document.getElementById('slideshow-typewriter-sentence').textContent = '';
            document.querySelectorAll('.fading, .showing, .move-up, .fade-in').forEach(el => { el.classList.remove('fading', 'showing', 'move-up', 'fade-in'); });
            startSlideshow();
        });
        
        if (!sessionStorage.getItem('flanerie-slideshow-seen')) {
            startSlideshow();
            sessionStorage.setItem('flanerie-slideshow-seen', 'true');
        } else {
            const slideshowOverlay = document.getElementById('slideshow-overlay');
            if (slideshowOverlay) { slideshowOverlay.style.display = 'none'; }
        }
        
        let currentHeroTextIndex = 0;
        const heroTextSpans = document.querySelectorAll('.hero .rotating-text span');
        function rotateHeroText() {
            heroTextSpans[currentHeroTextIndex].classList.remove('active');
            currentHeroTextIndex = (currentHeroTextIndex + 1) % heroTextSpans.length;
            heroTextSpans[currentHeroTextIndex].classList.add('active');
        }
        setInterval(rotateHeroText, 3000);
        
        function scrollToContent() { document.querySelector('.main-content').scrollIntoView({ behavior: 'smooth' }); }
        function scrollToExplore() { document.getElementById('features-content').scrollIntoView({ behavior: 'smooth' }); }
        window.scrollToContent = scrollToContent;
        window.scrollToExplore = scrollToExplore;
    </script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB4nznaJQ1VGNDylnfN5J9MW74Thm8XoS8",
            authDomain: "flanerie-70dfd.firebaseapp.com",
            databaseURL: "https://flanerie-70dfd-default-rtdb.firebaseio.com",
            projectId: "flanerie-70dfd",
            storageBucket: "flanerie-70dfd.firebasestorage.app",
            messagingSenderId: "367532686554",
            appId: "1:367532686554:web:0373f528284844cf5e79e3"
        };
        firebase.initializeApp(firebaseConfig);
        window.database = firebase.database();
        const database = window.database;
        window.auth = firebase.auth();
        const auth = window.auth;
        
        auth.onAuthStateChanged(async function(user) {
            if (user) {
                document.getElementById('sign-in-btn').style.display = 'none';
                document.getElementById('user-info').style.display = 'flex';
                const username = await getUsernameFromId(user.uid);
                document.getElementById('user-name').textContent = `Hi, ${username}!`;
                const isEmailPasswordUser = user.providerData[0].providerId === 'password';
                const verificationBanner = document.getElementById('verification-banner');
                if (isEmailPasswordUser && !user.emailVerified) {
                    verificationBanner.style.display = 'block';
                    startVerificationAutoCheck();
                } else {
                    verificationBanner.style.display = 'none';
                    if (verificationCheckInterval) { clearInterval(verificationCheckInterval); verificationCheckInterval = null; }
                }
                closeSignInModal();
            } else {
                document.getElementById('sign-in-btn').style.display = 'block';
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('verification-banner').style.display = 'none';
            }
        });
        
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && auth.currentUser) {
                auth.currentUser.reload().then(() => {
                    const user = auth.currentUser;
                    const isEmailPasswordUser = user.providerData[0].providerId === 'password';
                    const verificationBanner = document.getElementById('verification-banner');
                    if (isEmailPasswordUser && !user.emailVerified) {
                        if (verificationBanner.style.display === 'none') { verificationBanner.style.display = 'block'; startVerificationAutoCheck(); }
                    } else {
                        if (verificationBanner.style.display !== 'none') { verificationBanner.style.display = 'none'; showToast('‚úÖ Email verified! You can now start posting.'); }
                    }
                }).catch(console.error);
            }
        });
        
        let verificationCheckInterval = null;
        function startVerificationAutoCheck() {
            if (verificationCheckInterval) { clearInterval(verificationCheckInterval); }
            verificationCheckInterval = setInterval(() => {
                const user = auth.currentUser;
                const verificationBanner = document.getElementById('verification-banner');
                if (!user || verificationBanner.style.display === 'none') { clearInterval(verificationCheckInterval); verificationCheckInterval = null; return; }
                user.reload().then(() => {
                    const updatedUser = auth.currentUser;
                    if (updatedUser.emailVerified) {
                        verificationBanner.style.display = 'none';
                        clearInterval(verificationCheckInterval);
                        verificationCheckInterval = null;
                        showToast('‚úÖ Email verified! You can now start posting.');
                    }
                }).catch(console.error);
            }, 2000);
        }
        
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.id === 'verification-banner') {
                    const banner = mutation.target;
                    if (banner.style.display === 'block' && auth.currentUser && !auth.currentUser.emailVerified) { startVerificationAutoCheck(); }
                }
            });
        });
        const verificationBanner = document.getElementById('verification-banner');
        if (verificationBanner) { observer.observe(verificationBanner, { attributes: true, attributeFilter: ['style'] }); }
        
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(() => { showToast('Welcome to Fl√¢nerie!'); }).catch((error) => { console.error('Google sign-in error:', error); showToast('Error signing in with Google'); });
        }
        
        function signInWithEmail(event) {
            event.preventDefault();
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;
            auth.signInWithEmailAndPassword(email, password).then(() => { showToast('Welcome back!'); }).catch((error) => {
                if (error.code === 'auth/user-not-found') { showToast('No account found with this email'); } else if (error.code === 'auth/wrong-password') { showToast('Incorrect password'); } else { showToast('Error signing in'); }
            });
        }
        
        async function signUpWithEmail(event) {
            event.preventDefault();
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            const displayName = document.getElementById('signUpDisplayName').value.trim();
            if (!/^[a-zA-Z0-9_]+$/.test(displayName)) { showToast('Username can only contain letters, numbers, and underscores'); return; }
            if (displayName.length < 3 || displayName.length > 20) { showToast('Username must be 3-20 characters'); return; }
            const usernameLower = displayName.toLowerCase();
            const usernameCheck = await database.ref('usernames/' + usernameLower).once('value');
            if (usernameCheck.exists()) { showToast('Username is already taken!'); return; }
            auth.createUserWithEmailAndPassword(email, password).then((userCredential) => {
                const user = userCredential.user;
                return user.updateProfile({ displayName: displayName }).then(() => {
                    return database.ref('usernames/' + usernameLower).set(user.uid);
                }).then(() => { return user.sendEmailVerification(); });
            }).then(() => { showToast('Account created! You\'re signed in. Check your email for verification link.'); document.getElementById('user-name').textContent = `Hi, ${displayName}!`; })
            .catch((error) => { if (error.code === 'auth/email-already-in-use') { showToast('Email already in use'); } else if (error.code === 'auth/weak-password') { showToast('Password must be at least 6 characters'); } else { showToast('Error creating account'); } });
        }
        
        let usernameCheckTimeout = null;
        async function checkUsernameAvailability() {
            const usernameInput = document.getElementById('signUpDisplayName');
            const statusElement = document.getElementById('usernameStatus');
            const username = usernameInput.value.trim();
            if (usernameCheckTimeout) clearTimeout(usernameCheckTimeout);
            if (username.length === 0) { statusElement.textContent = ''; return; }
            if (username.length < 3) { statusElement.textContent = '‚úó Too short (min 3 characters)'; statusElement.style.color = '#d9534f'; return; }
            if (!/^[a-zA-Z0-9_]+$/.test(username)) { statusElement.textContent = '‚úó Only letters, numbers, and underscore allowed'; statusElement.style.color = '#d9534f'; return; }
            statusElement.textContent = '‚è≥ Checking...'; statusElement.style.color = '#999';
            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const usernameLower = username.toLowerCase();
                    const snapshot = await database.ref('usernames/' + usernameLower).once('value');
                    if (snapshot.exists()) { statusElement.textContent = '‚úó Username already taken'; statusElement.style.color = '#d9534f'; } 
                    else { statusElement.textContent = '‚úì Username available!'; statusElement.style.color = 'var(--accent-color)'; }
                } catch (error) { statusElement.textContent = '‚ö† Error'; }
            }, 500);
        }
        
        function showForgotPasswordModal() { document.getElementById('signInModal').style.display = 'none'; document.getElementById('forgotPasswordModal').style.display = 'flex'; }
        function closeForgotPasswordModal() { document.getElementById('forgotPasswordModal').style.display = 'none'; document.getElementById('forgotPasswordForm').reset(); }
        function sendPasswordResetEmail(event) {
            event.preventDefault();
            const email = document.getElementById('resetEmail').value;
            auth.sendPasswordResetEmail(email).then(() => { showToast('Password reset email sent! Check your inbox.'); closeForgotPasswordModal(); }).catch(() => { showToast('Error sending reset email'); });
        }
        function signOut() { auth.signOut().then(() => { showToast('Signed out successfully'); }); }
        function showSignInModal() { document.getElementById('signInModal').style.display = 'flex'; }
        function closeSignInModal() { document.getElementById('signInModal').style.display = 'none'; document.getElementById('signInForm').reset(); document.getElementById('signUpForm').reset(); }
        function checkAuthAndVerification() {
            const user = auth.currentUser;
            if (!user) { showSignInModal(); return false; }
            if (!user.emailVerified && user.providerData[0].providerId === 'password') { showToast('Please verify your email before posting. Check your inbox!'); return false; }
            return true;
        }
        function resendVerificationEmail() {
            const user = auth.currentUser;
            if (user && !user.emailVerified) { user.sendEmailVerification().then(() => { showToast('Verification email sent! Check your inbox.'); }).catch(() => { showToast('Failed to send verification email'); }); } 
            else if (user) { showToast('Email already verified!'); } else { showToast('Please sign in first'); }
        }
        
        function switchAuthTab(tab) {
            const signInTab = document.getElementById('signInTab'); const signUpTab = document.getElementById('signUpTab');
            const signInForm = document.getElementById('signInForm'); const signUpForm = document.getElementById('signUpForm');
            if (tab === 'signin') { signInTab.classList.add('active'); signUpTab.classList.remove('active'); signInTab.style.borderBottomColor = 'var(--accent-color)'; signUpTab.style.borderBottomColor = 'transparent'; signInForm.style.display = 'block'; signUpForm.style.display = 'none'; } 
            else { signUpTab.classList.add('active'); signInTab.classList.remove('active'); signUpTab.style.borderBottomColor = 'var(--accent-color)'; signInTab.style.borderBottomColor = 'transparent'; signUpForm.style.display = 'block'; signInForm.style.display = 'none'; }
        }
        
        window.signInWithGoogle = signInWithGoogle; window.signInWithEmail = signInWithEmail; window.signUpWithEmail = signUpWithEmail;
        window.signOut = signOut; window.showSignInModal = showSignInModal; window.closeSignInModal = closeSignInModal;
        window.switchAuthTab = switchAuthTab; window.checkAuthAndVerification = checkAuthAndVerification; window.resendVerificationEmail = resendVerificationEmail;
        window.checkUsernameAvailability = checkUsernameAvailability; window.showForgotPasswordModal = showForgotPasswordModal;
        window.closeForgotPasswordModal = closeForgotPasswordModal; window.sendPasswordResetEmail = sendPasswordResetEmail;
        
        // Dashboard
        async function openDashboard() {
            if (!auth.currentUser) { showSignInModal(); return; }
            document.getElementById('dashboardModal').style.display = 'flex';
            switchDashboardTab('routes');
        }
        function closeDashboard() { document.getElementById('dashboardModal').style.display = 'none'; }
        function switchDashboardTab(tab) {
            document.querySelectorAll('.dashboard-tab').forEach(btn => { btn.style.color = '#999'; btn.style.borderBottom = '3px solid transparent'; });
            document.getElementById(tab + 'Tab').style.color = 'var(--accent-light)';
            document.getElementById(tab + 'Tab').style.borderBottom = '3px solid var(--accent-color)';
            document.querySelectorAll('.dashboard-section').forEach(section => { section.style.display = 'none'; });
            document.getElementById(tab + 'Content').style.display = 'block';
            if (tab === 'routes') loadMyRoutes(); else if (tab === 'swarms') loadMySwarms(); else if (tab === 'events') loadMyEvents(); else if (tab === 'likes') loadMyLikes();
        }
        
        async function loadMyRoutes() {
            const user = auth.currentUser; if (!user) return;
            const contentDiv = document.getElementById('routesContent');
            contentDiv.innerHTML = '<p style="text-align: center; color: #999;">Loading...</p>';
            try {
                const snapshot = await database.ref('routes').orderByChild('createdBy').equalTo(user.uid).once('value');
                const routes = []; snapshot.forEach(child => routes.push({ id: child.key, ...child.val() }));
                if (routes.length === 0) { contentDiv.innerHTML = '<p style="text-align: center; color: #999;">You haven\'t created any routes yet.</p>'; return; }
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">';
                routes.forEach(route => {
                    html += `<div style="background: rgba(30, 30, 30, 0.8); border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; padding: 1.5rem;">
                        <h3 style="color: var(--accent-light); margin-bottom: 0.5rem;">${route.name}</h3>
                        <p style="color: #d4d4d4; font-size: 0.9rem; margin-bottom: 0.5rem;">${route.description || 'No description'}</p>
                        <p style="color: #999; font-size: 0.85rem; margin-bottom: 1rem;">üìç ${route.waypointCount} waypoints<br>üóÇÔ∏è ${route.category || 'Uncategorized'}<br>‚ù§Ô∏è ${route.likes || 0} fl√¢neurs like this<br>üìÖ ${new Date(route.created).toLocaleDateString()}</p>
                        <div style="display: flex; gap: 0.5rem;"><button onclick="viewRouteFromDashboard('${route.id}')" style="flex: 1; padding: 0.5rem; background: var(--accent-color); border: none; border-radius: 8px; color: white; cursor: pointer;">View on Map</button><button onclick="deleteRoute('${route.id}')" style="padding: 0.5rem 1rem; background: #d9534f; border: none; border-radius: 8px; color: white; cursor: pointer;">Delete</button></div></div>`;
                });
                html += '</div>'; contentDiv.innerHTML = html;
            } catch (error) { contentDiv.innerHTML = '<p style="text-align: center; color: #d9534f;">Error loading routes</p>'; }
        }
        
        async function loadMySwarms() {
            const user = auth.currentUser; if (!user) return;
            const contentDiv = document.getElementById('swarmsContent');
            contentDiv.innerHTML = '<p style="text-align: center; color: #999;">Loading...</p>';
            try {
                const snapshot = await database.ref('swarms').orderByChild('createdBy').equalTo(user.uid).once('value');
                const swarms = []; snapshot.forEach(child => swarms.push({ id: child.key, ...child.val() }));
                if (swarms.length === 0) { contentDiv.innerHTML = '<p style="text-align: center; color: #999;">You haven\'t created any swarms yet.</p>'; return; }
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">';
                swarms.forEach(swarm => {
                    html += `<div style="background: rgba(30, 30, 30, 0.8); border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; padding: 1.5rem;">
                        <h3 style="color: var(--accent-light); margin-bottom: 0.5rem;">${swarm.title}</h3>
                        <p style="color: #999; font-size: 0.85rem; margin-bottom: 1rem;">üìç ${swarm.locationCount || 1} locations<br>üìÖ ${swarm.date} at ${swarm.time}<br>üë• ${swarm.interested || 0} interested</p>
                        <div style="display: flex; gap: 0.5rem;"><button onclick="viewSwarmFromDashboard('${swarm.id}')" style="flex: 1; padding: 0.5rem; background: var(--accent-color); border: none; border-radius: 8px; color: white; cursor: pointer;">View on Map</button><button onclick="deleteSwarm('${swarm.id}')" style="padding: 0.5rem 1rem; background: #d9534f; border: none; border-radius: 8px; color: white; cursor: pointer;">Delete</button></div></div>`;
                });
                html += '</div>'; contentDiv.innerHTML = html;
            } catch (error) { contentDiv.innerHTML = '<p style="text-align: center; color: #d9534f;">Error loading swarms</p>'; }
        }
        
        async function loadMyEvents() {
            const user = auth.currentUser; if (!user) return;
            const contentDiv = document.getElementById('eventsContent');
            contentDiv.innerHTML = '<p style="text-align: center; color: #999;">Loading...</p>';
            try {
                const snapshot = await database.ref('events').orderByChild('createdBy').equalTo(user.uid).once('value');
                const events = []; snapshot.forEach(child => events.push({ id: child.key, ...child.val() }));
                if (events.length === 0) { contentDiv.innerHTML = '<p style="text-align: center; color: #999;">You haven\'t created any events yet.</p>'; return; }
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">';
                events.forEach(event => {
                    html += `<div style="background: rgba(30, 30, 30, 0.8); border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; padding: 1.5rem;">
                        <h3 style="color: var(--accent-light); margin-bottom: 0.5rem;">${event.name}</h3>
                        <p style="color: #999; font-size: 0.85rem; margin-bottom: 1rem;">üè∑Ô∏è ${event.type}<br>üìç ${event.location}<br>üìÖ ${event.startDate}</p>
                        <div style="display: flex; gap: 0.5rem;"><button onclick="viewEventFromDashboard('${event.id}')" style="flex: 1; padding: 0.5rem; background: var(--accent-color); border: none; border-radius: 8px; color: white; cursor: pointer;">View on Map</button><button onclick="deleteEvent('${event.id}')" style="padding: 0.5rem 1rem; background: #d9534f; border: none; border-radius: 8px; color: white; cursor: pointer;">Delete</button></div></div>`;
                });
                html += '</div>'; contentDiv.innerHTML = html;
            } catch (error) { contentDiv.innerHTML = '<p style="text-align: center; color: #d9534f;">Error loading events</p>'; }
        }
        
        async function loadMyLikes() {
            const contentDiv = document.getElementById('likesContent');
            contentDiv.innerHTML = '<div style="text-align: center; color: #999;"><p>Loading your likes...</p></div>';
            const user = auth.currentUser;
            if (!user) { contentDiv.innerHTML = '<p style="text-align: center; color: #d9534f;">Please sign in to view your likes</p>'; return; }
            try {
                const likedItems = [];
                const likesSnapshot = await database.ref(`userLikes/${user.uid}`).once('value');
                if (likesSnapshot.exists()) {
                    likesSnapshot.forEach((typeSnapshot) => {
                        typeSnapshot.forEach((itemSnapshot) => { likedItems.push({ action: 'liked', type: typeSnapshot.key, id: itemSnapshot.key }); });
                    });
                }
                const interestsSnapshot = await database.ref(`userInterests/${user.uid}`).once('value');
                if (interestsSnapshot.exists()) {
                    interestsSnapshot.forEach((typeSnapshot) => {
                        typeSnapshot.forEach((itemSnapshot) => { likedItems.push({ action: 'interested', type: typeSnapshot.key, id: itemSnapshot.key }); });
                    });
                }
                if (likedItems.length === 0) { contentDiv.innerHTML = '<p style="text-align: center; color: #999;">You haven\'t liked anything yet.</p>'; return; }
                
                const fetchedItems = [];
                for (const item of likedItems) {
                    const snapshot = await database.ref(`${item.type}/${item.id}`).once('value');
                    if (snapshot.val()) fetchedItems.push({ ...item, data: snapshot.val() });
                }
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">';
                fetchedItems.forEach(item => {
                    const emoji = item.type === 'routes' ? 'üö∂' : item.type === 'swarms' ? 'üõçÔ∏è' : 'üéâ';
                    const actionText = item.action === 'liked' ? 'Liked' : 'Interested in';
                    const sectionMap = { 'routes': 'search', 'swarms': 'swarms', 'events': 'events' };
                    html += `<div onclick="closeDashboard(); toggleSection('${sectionMap[item.type]}', '${item.id}')" style="background: rgba(30, 30, 30, 0.8); border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; padding: 1.5rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='var(--accent-color)'" onmouseout="this.style.borderColor='rgba(107, 155, 158, 0.3)'">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;"><span style="font-size: 1.5rem;">${emoji}</span><span style="color: #999; font-size: 0.85rem;">${actionText}</span></div>
                        <h3 style="color: var(--accent-light); margin-bottom: 0.5rem;">${item.data.name || item.data.title}</h3>
                        <p style="color: #d4d4d4; font-size: 0.9rem; margin-bottom: 0;">${item.data.description || 'No description'}</p></div>`;
                });
                html += '</div>'; contentDiv.innerHTML = html;
            } catch (error) { contentDiv.innerHTML = '<p style="text-align: center; color: #d9534f;">Error loading likes</p>'; }
        }
        
        async function deleteRoute(routeId) { if (confirm('Are you sure?')) { try { await database.ref(`routes/${routeId}`).remove(); showToast('Deleted'); loadMyRoutes(); } catch { showToast('Error deleting'); } } }
        async function deleteSwarm(swarmId) { if (confirm('Are you sure?')) { try { await database.ref(`swarms/${swarmId}`).remove(); showToast('Deleted'); loadMySwarms(); } catch { showToast('Error deleting'); } } }
        async function deleteEvent(eventId) { if (confirm('Are you sure?')) { try { await database.ref(`events/${eventId}`).remove(); showToast('Deleted'); loadMyEvents(); } catch { showToast('Error deleting'); } } }
        
        function viewRouteFromDashboard(routeId) { closeDashboard(); toggleSection('search', routeId); }
        function viewSwarmFromDashboard(swarmId) { closeDashboard(); toggleSection('swarms', swarmId); }
        function viewEventFromDashboard(eventId) { closeDashboard(); toggleSection('events', eventId); }
        function editRoute(id) { showToast('Edit coming soon! Delete and recreate for now.'); }
        function editSwarm(id) { showToast('Edit coming soon! Delete and recreate for now.'); }
        function editEvent(id) { showToast('Edit coming soon! Delete and recreate for now.'); }
        
        window.openDashboard = openDashboard; window.closeDashboard = closeDashboard; window.switchDashboardTab = switchDashboardTab;
        window.loadMyRoutes = loadMyRoutes; window.loadMySwarms = loadMySwarms; window.loadMyEvents = loadMyEvents; window.loadMyLikes = loadMyLikes;
        window.deleteRoute = deleteRoute; window.deleteSwarm = deleteSwarm; window.deleteEvent = deleteEvent;
        window.editRoute = editRoute; window.editSwarm = editSwarm; window.editEvent = editEvent;
        window.viewRouteFromDashboard = viewRouteFromDashboard; window.viewSwarmFromDashboard = viewSwarmFromDashboard; window.viewEventFromDashboard = viewEventFromDashboard;
        
        async function saveEventToFirebase(eventData) { const ref = database.ref('events').push(); await ref.set({ ...eventData, id: ref.key, created: new Date().toISOString() }); return ref.key; }
        async function saveSwarmToFirebase(swarmData) { const ref = database.ref('swarms').push(); await ref.set({ ...swarmData, id: ref.key, created: new Date().toISOString() }); return ref.key; }
        async function getAllEvents() { const snapshot = await database.ref('events').once('value'); const events = []; snapshot.forEach(c => events.push({ id: c.key, ...c.val() })); return events; }
        async function getAllSwarms() { const snapshot = await database.ref('swarms').once('value'); const swarms = []; snapshot.forEach(c => swarms.push({ id: c.key, ...c.val() })); return swarms; }
        async function updateInterestCount(type, id, count) { await database.ref(`${type === 'swarm' ? 'swarms' : 'events'}/${id}`).update({ interested: count }); }
        function getAllRoutes() { return new Promise(resolve => { database.ref('routes').once('value', (s) => { const r = []; s.forEach(c => r.push({ id: c.key, ...c.val() })); resolve(r); }); }); }
    </script>
    
    <script>
        let journeyMap = null, searchMap = null, swarmMap = null, eventMap = null;
        let routeMarkers = [], routePath = null, routeCoordinates = [], waypointLabels = [], allRoutesData = [], selectedRoute = null;
        
        function toggleSection(sectionId, highlightId = null) {
            const creationSections = ['journey-map', 'swarm-map', 'event-map', 'swarm-map-v2', 'event-map-v2'];
            if (creationSections.includes(sectionId)) { if (!checkAuthAndVerification()) return; }
            
            document.body.classList.add('choreography-active');
            const modal = document.createElement('div');
            modal.className = 'modal-fullscreen show'; modal.id = 'fullscreen-' + sectionId;
            modal.style.cssText = 'display: block; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100vh; background-color: rgba(10, 10, 10, 0.98);';
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = 'position: fixed; top: 2rem; right: 2rem; width: 50px; height: 50px; background: rgba(107, 155, 158, 0.9); border: none; border-radius: 50%; color: white; font-size: 2rem; cursor: pointer; z-index: 2001;';
            closeBtn.onclick = () => {
                modal.remove();
                document.body.classList.remove('choreography-active');
                
                // IMPORTANT: RESET STATE VARIABLES TO AVOID GHOST MARKERS
                routeMarkers = []; routeCoordinates = []; waypointLabels = []; routePath = null;
                if (window.swarmMarkers) window.swarmMarkers = [];
                if (window.swarmLocations) window.swarmLocations = [];
                window.eventLocation = null; window.eventMarker = null;
                
                journeyMap = null; searchMap = null; swarmMap = null; eventMap = null;
                
                setTimeout(() => {
                    const exploreSection = document.querySelector('.features-section');
                    if (exploreSection) exploreSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            };
            
            const content = document.createElement('div');
            content.style.cssText = 'padding: 3rem; max-width: 1600px; margin: 0 auto; padding-bottom: 4rem; height: 100vh; overflow: hidden;';
            const mapMode = sectionId.includes('swarm') ? 'swarm' : sectionId.includes('event') ? 'event' : 'journey';
            
            if (sectionId === 'journey-map' || sectionId === 'swarm-map-v2' || sectionId === 'event-map-v2') {
                content.style.cssText = 'padding: 0; max-width: none; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column;';
                const titles = { journey: 'Share Your Journey', swarm: 'üõçÔ∏è Create Shopping Swarm', event: 'üéâ Promote Your Event' };
                const buttons = {
                    journey: `<button class="feature-btn" onclick="openSaveRouteModal()">Save Route</button><button class="feature-btn" onclick="clearRoute()">Clear Route</button>`,
                    swarm: `<button id="saveSwarmMapBtn" class="feature-btn" onclick="openCreateSwarmModal()" disabled>Save Swarm</button><button class="feature-btn" onclick="clearSwarm()">Clear Swarm</button>`,
                    event: `<button id="saveEventMapBtn" class="feature-btn" onclick="openCreateEventModal()" disabled>Save Event</button><button class="feature-btn" onclick="clearEvent()">Clear Event</button>`
                };
                content.innerHTML = `<div style="padding: 2rem; text-align: center; background: rgba(20, 20, 20, 0.98); position: relative;">
                    <h2 style="color: var(--accent-color); margin: 0 0 1rem 0;">${titles[mapMode]}</h2>
                    <div style="max-width: 600px; margin: 0 auto;">
                        <input type="text" id="mapSearch" placeholder="Search address..." style="width: 100%; padding: 1rem; border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; background: rgba(40, 40, 40, 0.9); color: #e0e0e0; font-size: 1rem;">
                        <div id="mapSearchSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: rgba(30, 30, 30, 0.98); border: 2px solid rgba(107, 155, 158, 0.3); border-top: none; max-height: 300px; overflow-y: auto; z-index: 1000; display: none;"></div>
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">${buttons[mapMode]}</div>
                </div>
                <div id="map" style="height: calc(100vh - 400px); width: 100%;"></div>
                <div id="multiBusinessContainer" style="display: none; padding: 1rem 2rem; background: rgba(25, 25, 25, 0.95); text-align: center;">
                    <p style="color: #d4d4d4; margin: 0; font-size: 0.9rem;">Multi-business? <a href="#" onclick="event.preventDefault(); addAnotherBusiness();" style="color: var(--accent-color); font-weight: 600; text-decoration: underline;">Add another location</a></p>
                    <p id="businessCount" style="color: var(--accent-light); margin: 0.5rem 0 0 0; font-size: 0.85rem; font-weight: 600;"></p>
                </div>
                <div id="swarmBusinessLabelsContainer" style="display: none; padding: 1rem 2rem; background: rgba(25, 25, 25, 0.95); max-height: 200px; overflow-y: auto;">
                    <h4 style="color: var(--accent-color);">üè™ Label Businesses (Required)</h4><div id="swarmBusinessLabelsList" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                </div>
                <div id="waypointLabelsContainer" style="display: none; padding: 1rem 2rem; background: rgba(25, 25, 25, 0.95); max-height: 200px; overflow-y: auto;">
                    <h4 style="color: var(--accent-color);">üìç Label Stops (Required)</h4><div id="waypointLabelsList" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                </div>`;
            } else if (sectionId === 'search') {
                content.innerHTML = `<h2 style="color: var(--accent-color); margin-bottom: 1rem;">Search Routes</h2>
                <div style="margin-bottom: 1.5rem;">
                    <div style="margin-bottom: 1rem; position: relative;">
                        <input type="text" id="searchMapLocation" placeholder="Search route location..." style="width: 100%; padding: 1rem; border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; background: rgba(40, 40, 40, 0.9); color: #e0e0e0; font-size: 1rem;">
                        <div id="searchMapSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: rgba(30, 30, 30, 0.98); border: 2px solid rgba(107, 155, 158, 0.3); border-top: none; max-height: 300px; overflow-y: auto; z-index: 1000; display: none;"></div>
                    </div>
                    <label style="color: var(--accent-color); font-weight: 600; display: block; margin-bottom: 0.5rem;">Filter:</label>
                    <select id="categoryFilter" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; background: rgba(40, 40, 40, 0.9); color: #e0e0e0; font-size: 1rem;">
                        <option value="all">All Categories</option><option value="Coffee Shops">‚òï Coffee</option><option value="Tacos">üåÆ Tacos</option><option value="User Added">‚ú® User Added</option>
                    </select>
                </div>
                <div id="customCategoryFilterContainer" style="margin-bottom: 1.5rem; display: none;">
                    <select id="customCategoryFilter" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; background: rgba(40, 40, 40, 0.9); color: #e0e0e0; font-size: 1rem;"><option value="">All Custom</option></select>
                </div>
                <div id="search-map" style="height: 500px; border-radius: 15px; margin: 1rem 0;"></div>
                <div id="searchInfoPanel" style="display: none; padding: 1.5rem; background: rgba(25, 25, 25, 0.95); border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; margin: 1rem auto 0 auto; max-width: 500px;"><div id="searchInfoContent"></div></div>`;
            } else if (sectionId === 'swarms' || sectionId === 'events') {
                const type = sectionId === 'swarms' ? 'Swarm' : 'Event';
                content.innerHTML = `<h2 style="color: var(--accent-color); margin-bottom: 1rem;">${type === 'Swarm' ? 'Shopping Swarms' : 'Local Events'}</h2>
                <div style="margin-top: 2rem; margin-bottom: 1.5rem;">
                    <h3 style="color: var(--accent-light); margin-bottom: 1rem;">üîç Search</h3>
                    <div style="margin-bottom: 1rem; position: relative;">
                        <input type="text" id="${type.toLowerCase()}LocationSearch" placeholder="Search address..." style="width: 100%; padding: 1rem; border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; background: rgba(40, 40, 40, 0.9); color: #e0e0e0; font-size: 1rem;">
                        <div id="${type.toLowerCase()}SearchSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: rgba(30, 30, 30, 0.98); border: 2px solid rgba(107, 155, 158, 0.3); border-top: none; max-height: 300px; overflow-y: auto; z-index: 1000; display: none;"></div>
                    </div>
                </div>
                <div id="${type.toLowerCase()}-map" style="height: 500px; border-radius: 15px; margin: 1rem 0;"></div>
                <div id="${type.toLowerCase()}InfoPanel" style="display: none; padding: 1.5rem; background: rgba(25, 25, 25, 0.95); border: 2px solid rgba(107, 155, 158, 0.3); border-radius: 15px; margin: 1rem auto 0 auto; max-width: 500px;"><div id="${type.toLowerCase()}InfoContent"></div></div>`;
            }
            
            modal.appendChild(closeBtn); modal.appendChild(content); document.body.appendChild(modal);
            
            setTimeout(() => {
                if (sectionId === 'journey-map' || sectionId === 'swarm-map-v2' || sectionId === 'event-map-v2') {
                    journeyMap = L.map('map').setView([39.7392, -104.9903], 13);
                    L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaGlnaGRlZnBhbnRzIiwiYSI6ImNtaHpiNGt0NzBsNTIyam9saW45YmQ0Z3gifQ.EPETOMFI41QInYccb4Cehg', { tileSize: 512, zoomOffset: -1 }).addTo(journeyMap);
                    
                    if (mapMode === 'journey') { journeyMap.on('click', e => addWaypoint(e.latlng)); }
                    else if (mapMode === 'swarm') {
                        window.swarmMarkers = []; window.swarmLocations = []; window.swarmBusinessLabels = []; window.swarmMultiBusinessMode = false;
                        document.getElementById('multiBusinessContainer').style.display = 'block';
                        journeyMap.on('click', e => addSwarmMarker(e.latlng));
                    } else if (mapMode === 'event') {
                        journeyMap.on('click', e => {
                            if (window.eventMarker) journeyMap.removeLayer(window.eventMarker);
                            window.eventMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(journeyMap);
                            reverseGeocode(e.latlng.lat, e.latlng.lng).then(address => { window.eventLocation = { lat: e.latlng.lat, lng: e.latlng.lng, address: address }; });
                            document.getElementById('saveEventMapBtn').disabled = false;
                        });
                    }
                    setupAutocomplete('mapSearch', 'mapSearchSuggestions', journeyMap);
                } else if (sectionId === 'search') {
                    searchMap = L.map('search-map').setView([39.7392, -104.9903], 13);
                    L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaGlnaGRlZnBhbnRzIiwiYSI6ImNtaHpiNGt0NzBsNTIyam9saW45YmQ0Z3gifQ.EPETOMFI41QInYccb4Cehg', { tileSize: 512, zoomOffset: -1 }).addTo(searchMap);
                    allRoutesData = []; selectedRoute = null;
                    getAllRoutes().then(routes => {
                        allRoutesData = [];
                        routes.forEach(route => {
                            if (route.waypoints && route.waypoints.length >= 2) {
                                const polyline = L.polyline(route.waypoints, { color: "#8DBCC0", weight: 4, opacity: 0.7 });
                                const plainPin = L.marker(route.waypoints[0]);
                                const markers = route.waypoints.map((wp, i) => L.marker(wp, { icon: L.divIcon({ className: 'waypoint-number', html: `<div style="background:#0056b3;color:white;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;">${i+1}</div>` }) }));
                                const routeData = { route, polyline, markers, plainPin };
                                allRoutesData.push(routeData);
                                
                                polyline.on('click', () => {
                                    allRoutesData.forEach(r => { r.polyline.setStyle({ opacity: 0.3 }); if (searchMap.hasLayer(r.plainPin)) searchMap.removeLayer(r.plainPin); r.markers.forEach(m => searchMap.removeLayer(m)); });
                                    polyline.setStyle({ opacity: 1, weight: 6, color: '#0056b3' });
                                    markers.forEach(m => m.addTo(searchMap));
                                    selectedRoute = route;
                                    
                                    const infoPanel = document.getElementById('searchInfoPanel');
                                    const infoContent = document.getElementById('searchInfoContent');
                                    infoContent.innerHTML = `<h3>${route.name}</h3><p>${route.description || ''}</p><p>‚ù§Ô∏è ${route.likes || 0} Likes</p>
                                    <button onclick="toggleLike('routes', '${route.id}')">Like</button>
                                    <button onclick="closeRouteInfo()">Close</button>`;
                                    infoPanel.style.display = 'block';
                                });
                                plainPin.on('click', () => polyline.fire('click'));
                                polyline.addTo(searchMap); plainPin.addTo(searchMap);
                            }
                        });
                        if (highlightId) {
                            allRoutesData.forEach(d => { if (d.route.id === highlightId) { d.polyline.fire('click'); searchMap.fitBounds(d.polyline.getBounds()); } });
                        }
                    });
                    setupAutocomplete('searchMapLocation', 'searchMapSuggestions', searchMap);
                } else if (sectionId === 'swarms' || sectionId === 'events') {
                    const type = sectionId === 'swarms' ? 'swarm' : 'event';
                    const mapEl = type + '-map';
                    if (type === 'swarm') swarmMap = L.map(mapEl).setView([39.7392, -104.9903], 13);
                    else eventMap = L.map(mapEl).setView([39.7392, -104.9903], 13);
                    const map = type === 'swarm' ? swarmMap : eventMap;
                    L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaGlnaGRlZnBhbnRzIiwiYSI6ImNtaHpiNGt0NzBsNTIyam9saW45YmQ0Z3gifQ.EPETOMFI41QInYccb4Cehg', { tileSize: 512, zoomOffset: -1 }).addTo(map);
                    
                    const fetchFunc = type === 'swarm' ? getAllSwarms : getAllEvents;
                    fetchFunc().then(items => {
                        items.forEach(item => {
                            if (item.lat && item.lng) {
                                const marker = L.marker([item.lat, item.lng]).addTo(map);
                                marker.on('click', () => {
                                    document.getElementById(`${type}InfoPanel`).style.display = 'block';
                                    document.getElementById(`${type}InfoContent`).innerHTML = `<h3>${item.title || item.name}</h3><p>${item.description || ''}</p><button onclick="toggleInterest('${type}s', '${item.id}')">Interested</button><button onclick="close${type === 'swarm' ? 'Swarm' : 'Event'}Info()">Close</button>`;
                                });
                                if (highlightId && item.id === highlightId) { marker.fire('click'); map.setView([item.lat, item.lng], 15); }
                            }
                        });
                    });
                    setupAutocomplete(`${type}LocationSearch`, `${type}SearchSuggestions`, map);
                }
            }, 500);
        }
        
        window.toggleSection = toggleSection;
        
        function setupAutocomplete(inputId, divId, map) {
            const input = document.getElementById(inputId);
            const div = document.getElementById(divId);
            if (!input || !div) return;
            let timeout;
            input.addEventListener('input', e => {
                clearTimeout(timeout);
                if (e.target.value.length < 3) { div.style.display = 'none'; return; }
                timeout = setTimeout(() => fetchLocationSuggestions(e.target.value, div, map, input), 300);
            });
        }
        
        function fetchLocationSuggestions(query, suggestionsDiv, map, inputElement) {
            const accessToken = 'pk.eyJ1IjoiaGlnaGRlZnBhbnRzIiwiYSI6ImNtaHpiNGt0NzBsNTIyam9saW45YmQ0Z3gifQ.EPETOMFI41QInYccb4Cehg';
            fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${accessToken}&country=us&limit=5`)
            .then(r => r.json()).then(data => {
                suggestionsDiv.innerHTML = '';
                if (data.features?.length) {
                    data.features.forEach(f => {
                        const item = document.createElement('div');
                        item.style.padding = '10px'; item.style.cursor = 'pointer'; item.style.color = '#fff';
                        item.textContent = f.place_name;
                        item.onclick = () => {
                            const [lng, lat] = f.center;
                            if (map) {
                                map.setView([lat, lng], 15);
                                if (map === window.eventMap) window.eventLocation = { lat, lng, address: f.place_name };
                            }
                            inputElement.value = f.place_name; suggestionsDiv.style.display = 'none';
                        };
                        suggestionsDiv.appendChild(item);
                    });
                    suggestionsDiv.style.display = 'block';
                }
            });
        }
        
        function addWaypoint(latlng) {
            const num = routeCoordinates.length + 1;
            const marker = L.marker(latlng).addTo(journeyMap);
            routeMarkers.push(marker); routeCoordinates.push([latlng.lat, latlng.lng]); waypointLabels.push('');
            
            document.getElementById('waypointLabelsContainer').style.display = 'block';
            const div = document.createElement('div');
            div.innerHTML = `<span>${num}.</span> <input type="text" id="waypointLabel${num}" placeholder="Stop name..." oninput="waypointLabels[${num-1}] = this.value">`;
            document.getElementById('waypointLabelsList').appendChild(div);
            
            if (routePath) journeyMap.removeLayer(routePath);
            if (routeCoordinates.length > 1) routePath = L.polyline(routeCoordinates, { color: 'var(--accent-color)' }).addTo(journeyMap);
        }
        
        function addSwarmMarker(latlng) {
            if (!window.swarmMultiBusinessMode && window.swarmMarkers.length >= 1) { showToast('Click "Add another location" for more'); return; }
            const num = window.swarmMarkers.length + 1;
            const marker = L.marker([latlng.lat, latlng.lng]).addTo(journeyMap);
            window.swarmMarkers.push(marker);
            if (!window.swarmBusinessLabels) window.swarmBusinessLabels = [];
            window.swarmBusinessLabels.push('');
            
            reverseGeocode(latlng.lat, latlng.lng).then(addr => {
                window.swarmLocations.push({ lat: latlng.lat, lng: latlng.lng, address: addr });
                document.getElementById('saveSwarmMapBtn').disabled = false;
                document.getElementById('businessCount').textContent = `${num} location(s)`;
                
                document.getElementById('swarmBusinessLabelsContainer').style.display = 'block';
                const div = document.createElement('div');
                div.innerHTML = `<span>${num}.</span> <input type="text" id="swarmBusinessLabel${num}" value="${addr.split(',')[0]}" oninput="window.swarmBusinessLabels[${num-1}] = this.value">`;
                document.getElementById('swarmBusinessLabelsList').appendChild(div);
                window.swarmBusinessLabels[num-1] = addr.split(',')[0];
            });
        }
        
        function addAnotherBusiness() { window.swarmMultiBusinessMode = true; showToast('Multi-business mode on'); }
        function clearRoute() { routeMarkers.forEach(m => journeyMap.removeLayer(m)); if (routePath) journeyMap.removeLayer(routePath); routeMarkers = []; routeCoordinates = []; waypointLabels = []; document.getElementById('waypointLabelsList').innerHTML = ''; }
        function clearSwarm() { if (window.swarmMarkers) window.swarmMarkers.forEach(m => journeyMap.removeLayer(m)); window.swarmMarkers = []; window.swarmLocations = []; window.swarmBusinessLabels = []; document.getElementById('swarmBusinessLabelsList').innerHTML = ''; }
        function clearEvent() { if (window.eventMarker) journeyMap.removeLayer(window.eventMarker); window.eventMarker = null; window.eventLocation = null; }
        
        // Helper Functions & Global Exports
        async function getUsernameFromId(uid) { return 'User'; } // Simplified for brevity in this cleanup
        window.clearRoute = clearRoute; window.clearSwarm = clearSwarm; window.clearEvent = clearEvent;
        window.openSaveRouteModal = openSaveRouteModal; window.confirmSaveRoute = confirmSaveRoute;
        window.openCreateSwarmModal = openCreateSwarmModal; window.closeCreateSwarmModal = closeCreateSwarmModal;
        window.openCreateEventModal = openCreateEventModal; window.closeCreateEventModal = closeCreateEventModal;
        window.toggleCustomEventType = toggleCustomEventType; window.toggleCustomRouteCategory = toggleCustomRouteCategory;
        window.submitSwarm = submitSwarm; window.submitEvent = submitEvent;
        window.addInterest = addInterest; window.toggleLike = toggleLike; window.toggleInterest = toggleInterest;
        window.closeRouteInfo = closeRouteInfo; window.closeSwarmInfo = closeSwarmInfo; window.closeEventInfo = closeEventInfo;
        window.showToast = showToast; window.addAnotherBusiness = addAnotherBusiness;
    </script>
</body>
</html>
